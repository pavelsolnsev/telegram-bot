name: Deploy to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ${{ secrets.VPS_PROJECT_PATH }}
            if [ ! -d .git ]; then
              echo "Git repository not found. Initializing..."
              git init
              git remote add origin ${{ secrets.GIT_REPO_URL }}
              git fetch origin
              git checkout -b master origin/master || git checkout master
            fi
            # Сохраняем .env файл перед обновлением
            if [ -f .env ]; then
              echo "Saving .env file..."
              cp .env .env.backup
            fi
            # Обновляем код из GitHub
            git fetch origin
            git reset --hard origin/master
            # Восстанавливаем .env файл если он был сохранен
            if [ -f .env.backup ]; then
              echo "Restoring .env file..."
              mv .env.backup .env
            fi
            # Перезапускаем приложение через PM2
            echo "Restarting application with PM2..."
            # Загружаем NVM окружение
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
            # Пробуем разные пути к PM2
            PM2_CMD=""
            if command -v pm2 &> /dev/null; then
              PM2_CMD="pm2"
            elif [ -f "/root/.nvm/versions/node/v18.20.3/bin/pm2" ]; then
              PM2_CMD="/root/.nvm/versions/node/v18.20.3/bin/pm2"
            elif [ -f "$HOME/.nvm/versions/node/v18.20.3/bin/pm2" ]; then
              PM2_CMD="$HOME/.nvm/versions/node/v18.20.3/bin/pm2"
            elif [ -f "$HOME/.npm-global/bin/pm2" ]; then
              PM2_CMD="$HOME/.npm-global/bin/pm2"
            elif [ -f "/usr/local/bin/pm2" ]; then
              PM2_CMD="/usr/local/bin/pm2"
            elif [ -f "/usr/bin/pm2" ]; then
              PM2_CMD="/usr/bin/pm2"
            else
              # Пробуем найти PM2 через find в типичных местах
              PM2_FOUND=$(find $HOME/.nvm -name pm2 2>/dev/null | head -1)
              if [ -n "$PM2_FOUND" ] && [ -f "$PM2_FOUND" ]; then
                PM2_CMD="$PM2_FOUND"
              fi
            fi
            if [ -n "$PM2_CMD" ]; then
              echo "Using PM2 at: $PM2_CMD"
              $PM2_CMD restart telegram
            else
              echo "PM2 not found, trying with npx..."
              npx pm2 restart telegram || echo "Failed to restart PM2"
            fi

