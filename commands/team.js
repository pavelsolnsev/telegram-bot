const { Markup } = require("telegraf");
const { GlobalState } = require("../store");

const { deleteMessageAfterDelay } = require("../utils/deleteMessageAfterDelay"); // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
const reshuffleArray = (arr) => arr.sort(() => Math.random() - 0.5);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
const divideIntoTeams = (players, numTeams) => {
  // –°–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ —Å –ø—É—Å—Ç—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ = numTeams)
  const teams = Array.from({ length: numTeams }, () => []);

  // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –ø–æ –æ—á–µ—Ä–µ–¥–∏
  players.forEach((player, index) => {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä –æ—Å—Ç–∞—Ç–∫–∞ % –¥–ª—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    teams[index % numTeams].push(player);
  });

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –∫–æ–º–∞–Ω–¥
  return teams;
};


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–æ—Å—Ç–∞–≤–∞–º–∏ –∫–æ–º–∞–Ω–¥
const buildTeamsMessage = (teams, title = "–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥") => {
  // –ù–∞—á–∏–Ω–∞–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º HTML-—Ä–∞–∑–º–µ—Ç–∫—É)
  let message = `üèÜ <b>${title}:</b>\n\n`;

  // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
  teams.forEach((team, index) => {
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
    message += `‚öΩ <b>–ö–æ–º–∞–Ω–¥–∞ ${index + 1}:</b>\n`;

    // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–∞–Ω–¥–µ
    team.forEach((player, i) => {
      // –ï—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å –∑–∞–±–∏—Ç—ã–µ –≥–æ–ª—ã, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ–ª–∞—Ö
      const goalsText =
        player.goals && player.goals > 0 ? ` - –ì–æ–ª—ã: ${player.goals}` : "";

      // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–æ–º–µ—Ä –≤ —Å–ø–∏—Å–∫–µ, –∏–º—è, –Ω–∏–∫–Ω–µ–π–º (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –≥–æ–ª—ã)
      message += `${i + 1}. ${player.name} ${
        player.username ? `(${player.username})` : ""
      }${goalsText}\n`;
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
    message += "\n";
  });

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  return message;
};


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–æ—Å—Ç–∞–≤–∞–º–∏ –∫–æ–º–∞–Ω–¥ –∏ –∫–Ω–æ–ø–∫–æ–π "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Å–æ—Å—Ç–∞–≤"
const sendTeamsMessage = async (ctx, message) => {
  // –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Å–æ—Å—Ç–∞–≤"
  const inlineKeyboard = Markup.inlineKeyboard([
    Markup.button.callback("–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Å–æ—Å—Ç–∞–≤", "reshuffle_callback"),
  ]);

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–æ—Å—Ç–∞–≤–∞–º–∏ –∫–æ–º–∞–Ω–¥ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
  const sentMessage = await ctx.reply(message, {
    parse_mode: "HTML", // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTML-—Ä–∞–∑–º–µ—Ç–∫–∞
    reply_markup: inlineKeyboard.reply_markup, // –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
  });

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏,
  // —á—Ç–æ–±—ã –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –µ–≥–æ –æ–±–Ω–æ–≤–∏—Ç—å
  GlobalState.setLastTeamsMessageId(
    sentMessage.chat.id, // ID —á–∞—Ç–∞, –≥–¥–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    sentMessage.message_id // ID —Å–∞–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  );
};


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Å –∏–≥—Ä–æ–∫–∞–º–∏ –∫–æ–º–∞–Ω–¥—ã
const createTeamButtons = (team, teamIndex) => {
  return team.map((player, index) => 
    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Å –Ω–æ–º–µ—Ä–æ–º –∏–≥—Ä–æ–∫–∞ –∏ –µ–≥–æ –∏–º–µ–Ω–µ–º
    Markup.button.callback(
      `${index + 1}. ${player.name}`, // –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ (–Ω–æ–º–µ—Ä –∏ –∏–º—è –∏–≥—Ä–æ–∫–∞)
      `goal_${teamIndex}_${index}` // Callback-–¥–∞–Ω–Ω—ã–µ (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è)
    )
  );
};


module.exports = (bot, GlobalState) => {
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —à–∞–±–ª–æ–Ω—É "goal_X_Y"
  // –ì–¥–µ X ‚Äî –Ω–æ–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã, Y ‚Äî –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ –≤ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ
  bot.action(/goal_(\d+)_(\d+)/, async (ctx) => {
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –∫–æ–º–∞–Ω–¥—ã –∏ –∏–≥—Ä–æ–∫–∞ –∏–∑ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–Ω–æ–ø–∫–µ
    const teamIndex = parseInt(ctx.match[1], 10); // –ò–Ω–¥–µ–∫—Å –∫–æ–º–∞–Ω–¥—ã
    const playerIndex = parseInt(ctx.match[2], 10); // –ò–Ω–¥–µ–∫—Å –∏–≥—Ä–æ–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const teams = GlobalState.getTeams();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏ —Ç–∞–∫–æ–π –∏–≥—Ä–æ–∫
    if (!teams[teamIndex] || !teams[teamIndex][playerIndex]) {
      return ctx.answerCbQuery("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!"); // –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç
    }

    // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ
    const player = teams[teamIndex][playerIndex];

    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ–≤ —É –∏–≥—Ä–æ–∫–∞ (–µ—Å–ª–∏ –≥–æ–ª–æ–≤ –Ω–µ –±—ã–ª–æ, —Å—Ç–∞–≤–∏–º 0 –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º 1)
    player.goals = (player.goals || 0) + 1;

    // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –∫–æ–º–∞–Ω–¥ –∏ –≥–æ–ª–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
    const teamsMessage = buildTeamsMessage(teams, "–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥ (–æ–±–Ω–æ–≤–ª–µ–Ω—ã)");

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    GlobalState.setTeams(teams);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥–æ–ª–∞ –∏–≥—Ä–æ–∫—É
    await ctx.answerCbQuery(`–ì–æ–ª –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${player.name}!`);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ–≤
    await ctx.editMessageText(teamsMessage, {
      parse_mode: "HTML", // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML
      reply_markup: Markup.inlineKeyboard(
        teams.flatMap((team, teamIndex) => createTeamButtons(team, teamIndex)) // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
      ).reply_markup,
    });
  });

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É "team 2", "team 3" –∏–ª–∏ "team 4"
  // –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ 2, 3 –∏–ª–∏ 4 –∫–æ–º–∞–Ω–¥—ã
  bot.hears(/^team (2|3|4)$/i, async (ctx) => {
    // –ü–æ–ª—É—á–∞–µ–º ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const ADMIN_ID = GlobalState.getAdminId();

    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á—Ç–æ–±—ã —á–∞—Ç –Ω–µ –∑–∞—Å–æ—Ä—è–ª—Å—è)
    await ctx.deleteMessage().catch(() => {});

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    if (ctx.from.id !== ADMIN_ID) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "‚õî –ù–µ—Ç –ø—Ä–∞–≤!" –∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
      const msg = await ctx.reply("‚õî –ù–µ—Ç –ø—Ä–∞–≤!");
      return deleteMessageAfterDelay(ctx, msg.message_id);
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "team 3" ‚Üí 3)
    const numTeams = parseInt(ctx.message.text.split(" ")[1], 10);

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let players = [...GlobalState.getPlayers()];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥
    if (players.length < numTeams) {
      return ctx.reply("‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥!");
    }

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
    players = reshuffleArray(players);

    // –†–∞–∑–¥–µ–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –∑–∞–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥
    const teams = divideIntoTeams(players, numTeams);

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–æ—Å—Ç–∞–≤–∞–º–∏ –∫–æ–º–∞–Ω–¥
    const teamsMessage = buildTeamsMessage(teams, "–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥");

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    GlobalState.setTeams(teams);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (—á—Ç–æ–±—ã –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–µ—Ä–µ–º–µ—à–∞—Ç—å –∏—Ö –∑–∞–Ω–æ–≤–æ)
    GlobalState.setLastTeamCount(numTeams);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –≤ —á–∞—Ç
    await sendTeamsMessage(ctx, teamsMessage);
  });

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É "g X Y", –≥–¥–µ:
  // X ‚Äî –Ω–æ–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã (–Ω–∞—á–∏–Ω–∞—è —Å 1)
  // Y ‚Äî –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ (–Ω–∞—á–∏–Ω–∞—è —Å 1)
  bot.hears(/^g (\d+) (\d+)$/, async (ctx) => {
    // –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —á–∞—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "g 1 2" ‚Üí ["g", "1", "2"])
    const args = ctx.message.text.split(" ");

    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã –∏ —É–º–µ–Ω—å—à–∞–µ–º –µ–≥–æ –Ω–∞ 1 (—á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—É –º–∞—Å—Å–∏–≤–∞)
    const teamIndex = parseInt(args[1], 10) - 1;

    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ –∏ —É–º–µ–Ω—å—à–∞–µ–º –µ–≥–æ –Ω–∞ 1 (—á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—É –º–∞—Å—Å–∏–≤–∞)
    const playerIndex = parseInt(args[2], 10) - 1;

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const teams = GlobalState.getTeams();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏ –∏–≥—Ä–æ–∫ –≤ –Ω–µ–π
    if (!teams[teamIndex] || !teams[teamIndex][playerIndex]) {
      return ctx.reply("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!"); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç
    }

    // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä–æ–∫–∞
    const player = teams[teamIndex][playerIndex];

    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ–≤ (–µ—Å–ª–∏ –≥–æ–ª–æ–≤ –Ω–µ –±—ã–ª–æ, —Å—Ç–∞–≤–∏–º 0 –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º 1)
    player.goals = (player.goals || 0) + 1;

    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏
    const teamsMessage = buildTeamsMessage(teams, "–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥ (–æ–±–Ω–æ–≤–ª–µ–Ω—ã)");

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    GlobalState.setTeams(teams);

    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏
    const sentMessages = GlobalState.getLastTeamsMessageId();

    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
    if (sentMessages) {
      try {
        await ctx.telegram.editMessageText(
          sentMessages.chatId, // ID —á–∞—Ç–∞
          sentMessages.messageId, // ID —Å–æ–æ–±—â–µ–Ω–∏—è
          null,
          teamsMessage, // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏
          {
            parse_mode: "HTML",
            reply_markup: Markup.inlineKeyboard(
              teams.flatMap(
                (team, teamIndex) => createTeamButtons(team, teamIndex) // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
              )
            ).reply_markup,
          }
        );
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–æ–º–∞–Ω–¥–∞–º–∏:", error);
      }
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–º –≥–æ–ª–µ
    await ctx.reply(
      `–ì–æ–ª –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${player.name}. –¢–µ–ø–µ—Ä—å —É –Ω–µ–≥–æ ${player.goals} –≥–æ–ª(–æ–≤).`
    );

    // –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log("player", player);
    console.log("teams", teams);
  });

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É "play X Y", –≥–¥–µ:
  // X ‚Äî –Ω–æ–º–µ—Ä –ø–µ—Ä–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
  // Y ‚Äî –Ω–æ–º–µ—Ä –≤—Ç–æ—Ä–æ–π –∫–æ–º–∞–Ω–¥—ã
  bot.hears(/^play (\d+) (\d+)$/, async (ctx) => {
    // –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —á–∞—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "play 1 2" ‚Üí ["play", "1", "2"])
    const args = ctx.message.text.split(" ");

    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –ø–µ—Ä–≤–æ–π –∫–æ–º–∞–Ω–¥—ã –∏ —É–º–µ–Ω—å—à–∞–µ–º –µ–≥–æ –Ω–∞ 1 (—á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—É –º–∞—Å—Å–∏–≤–∞)
    const teamIndex1 = parseInt(args[1], 10) - 1;

    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –≤—Ç–æ—Ä–æ–π –∫–æ–º–∞–Ω–¥—ã –∏ —É–º–µ–Ω—å—à–∞–µ–º –µ–≥–æ –Ω–∞ 1 (—á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—É –º–∞—Å—Å–∏–≤–∞)
    const teamIndex2 = parseInt(args[2], 10) - 1;

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const teams = GlobalState.getTeams();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    if (!teams[teamIndex1] || !teams[teamIndex2]) {
      return ctx.reply("–ö–æ–º–∞–Ω–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!"); // –ï—Å–ª–∏ –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    }

    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–∞–≤—ã –¥–≤—É—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
    const team1 = teams[teamIndex1];
    const team2 = teams[teamIndex2];

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–æ—Å—Ç–∞–≤–∞–º–∏ –∏–≥—Ä–∞—é—â–∏—Ö –∫–æ–º–∞–Ω–¥
    let message = "üî• –ò–≥—Ä–∞—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n\n";

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤ –ø–µ—Ä–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
    message += `<b>–ö–æ–º–∞–Ω–¥–∞ ${teamIndex1 + 1}:</b>\n`;
    team1.forEach((player, index) => {
      message += `${index + 1}. ${player.name} (${
        player.username || "–ë–µ–∑ username"
      })\n`;
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤ –≤—Ç–æ—Ä–æ–π –∫–æ–º–∞–Ω–¥—ã
    message += `\n<b>–ö–æ–º–∞–Ω–¥–∞ ${teamIndex2 + 1}:</b>\n`;
    team2.forEach((player, index) => {
      message += `${index + 1}. ${player.name} (${
        player.username || "–ë–µ–∑ username"
      })\n`;
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –≤ —á–∞—Ç, –∏—Å–ø–æ–ª—å–∑—É—è HTML-—Ä–∞–∑–º–µ—Ç–∫—É
    await ctx.reply(message, { parse_mode: "HTML" });
  });

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Å–æ—Å—Ç–∞–≤"
  bot.action("reshuffle_callback", async (ctx) => {
    // –ü–æ–ª—É—á–∞–µ–º ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    const ADMIN_ID = GlobalState.getAdminId();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    if (ctx.from.id !== ADMIN_ID) {
      return ctx.answerCbQuery("‚õî –ù–µ—Ç –ø—Ä–∞–≤!"); // –ï—Å–ª–∏ –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑
    const numTeams = GlobalState.getLastTeamCount();

    // –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥—ã –µ—â–µ –Ω–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if (!numTeams) {
      return ctx.answerCbQuery("‚ö†Ô∏è –ö–æ–º–∞–Ω–¥—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã!");
    }

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
    let players = [...GlobalState.getPlayers()];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥
    if (players.length < numTeams) {
      return ctx.answerCbQuery("‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥!");
    }

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
    players = reshuffleArray(players);

    // –î–µ–ª–∏–º –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥
    const teams = divideIntoTeams(players, numTeams);

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ —Å–æ—Å—Ç–∞–≤–∞–º–∏ –∫–æ–º–∞–Ω–¥
    const teamsMessage = buildTeamsMessage(
      teams,
      "–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥ (–ø–µ—Ä–µ–º–µ—à–∞–Ω—ã)"
    );

    // –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è
    const inlineKeyboard = Markup.inlineKeyboard([
      Markup.button.callback("–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Å–æ—Å—Ç–∞–≤", "reshuffle_callback"),
    ]);

    try {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ —Å –Ω–æ–≤—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
      await ctx.editMessageText(teamsMessage, {
        parse_mode: "HTML",
        reply_markup: inlineKeyboard.reply_markup,
      });

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —á—Ç–æ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã
      await ctx.answerCbQuery("–ö–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã!");
    } catch (error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ –æ—à–∏–±–∫–∏ "message is not modified" (–µ—Å–ª–∏ —Å–æ—Å—Ç–∞–≤—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
      if (
        error.response &&
        error.response.description &&
        error.response.description.includes("message is not modified")
      ) {
        return ctx.answerCbQuery("–ö–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã!");
      }

      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥:", error);
      await ctx.answerCbQuery("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥!");
    }
  });
};
