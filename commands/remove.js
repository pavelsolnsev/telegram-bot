const { deleteMessageAfterDelay } = require("../utils/deleteMessageAfterDelay");
const { sendPlayerList } = require("../utils/sendPlayerList");
const { sendPrivateMessage } = require("../message/sendPrivateMessage"); // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç sendPrivateMessage

module.exports = (bot, GlobalState) => {
  bot.hears(/^r(\d+)$/i, async (ctx) => {
    const ADMIN_ID = GlobalState.getAdminId();
    const isMatchStarted = GlobalState.getStart();
    const players = GlobalState.getPlayers();
    const queue = GlobalState.getQueue();
    const isTeamsDivided = GlobalState.getDivided();
    await ctx.deleteMessage().catch(() => {});

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    if (ctx.from.id !== ADMIN_ID) {
      const message = await ctx.reply("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.");
      return deleteMessageAfterDelay(ctx, message.message_id);
    }

    if (!isMatchStarted) {
      const message = await ctx.reply("‚ö†Ô∏è –ú–∞—Ç—á –Ω–µ –Ω–∞—á–∞—Ç!");
      return deleteMessageAfterDelay(ctx, message.message_id);
    }

    if (isTeamsDivided) {
      const message = await ctx.reply("–ò–≥—Ä–∞ —É–∂–µ –∏–¥–µ—Ç!");
      return deleteMessageAfterDelay(ctx, message.message_id);
    }

    if (ctx.chat.id > 0) {
      const message = await ctx.reply("–ù–∞–ø–∏—à–∏ –≤ –≥—Ä—É–ø–ø—É!");
      return deleteMessageAfterDelay(ctx, message.message_id, 3000);
    }

    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–æ–º–∞–Ω–¥—ã
    const playerNumber = Number(ctx.message.text.match(/^r(\d+)$/i)[1]);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
    if (playerNumber <= 0 || playerNumber > players.length) {
      const message = await ctx.reply("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞!");
      return deleteMessageAfterDelay(ctx, message.message_id);
    }

    // –ù–∞—Ö–æ–¥–∏–º –∏–≥—Ä–æ–∫–∞ –ø–æ –µ–≥–æ –Ω–æ–º–µ—Ä—É
    const playerIndex = playerNumber - 1;
    const playerName = players[playerIndex].name;

    // –£–¥–∞–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
    players.splice(playerIndex, 1);

    // –ï—Å–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –µ—Å—Ç—å –∏–≥—Ä–æ–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
    if (queue.length > 0) {
      const newPlayer = queue.shift(); // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
      players.push(newPlayer); // –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Å—Ç–∞–≤
      sendPrivateMessage(bot, newPlayer.id, "üéâ –í—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ—Å—Ç–∞–≤–µ!"); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –∏ –æ—á–µ—Ä–µ–¥—å –≤ GlobalState
    GlobalState.setPlayers(players);
    GlobalState.setQueue(queue);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –±—ã–ª —É–¥–∞–ª—ë–Ω
    const message = await ctx.reply(`‚úÖ –ò–≥—Ä–æ–∫ ${playerName} —É–¥–∞–ª—ë–Ω –∏–∑ —Å–ø–∏—Å–∫–∞!`);
    deleteMessageAfterDelay(ctx, message.message_id);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
    await sendPlayerList(ctx);
  });
};